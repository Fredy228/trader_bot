<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
    <div id="chart" style="height:50vh; width: 100vw;"></div>
    <div id="chart-balance" style="height:50vh; width: 100vw;"></div>

    <script type="module">
        const chart = LightweightCharts.createChart(document.getElementById('chart'));
        const chartBalance = LightweightCharts.createChart(document.getElementById('chart-balance'));

        const candleSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false,
            wickUpColor: '#26a69a', wickDownColor: '#ef5350',
        });

        const trendSeries = chart.addSeries(LightweightCharts.LineSeries, { color: '#2962FF' });

        const balanceSeries = chartBalance.addSeries(LightweightCharts.AreaSeries, { lineColor: '#2962FF', topColor: '#2962FF', bottomColor: 'rgba(41, 98, 255, 0.28)' });


        fetch(`http://${location.host}/data`, { method: "GET" })
            .then(r => r.json())
            .then(({ candles, trend, markers, balance }) => {

                function findDuplicates(arr) {
                const count = new Map();

                // Подсчёт количества повторений для каждого time
                for (const item of arr) {
                    count.set(item.time, (count.get(item.time) || 0) + 1);
                }

                // Отбор объектов с дублирующимся time
                return arr.filter((item) => count.get(item.time) > 1);
                }

                const duplicates = findDuplicates(balance);
                console.log(duplicates);

                candleSeries.setData(candles);
                trendSeries.setData(trend);
                balanceSeries.setData(balance);
                LightweightCharts.createSeriesMarkers(candleSeries, markers)
                chartBalance.timeScale().fitContent();
            });
    </script>
</body>

</html>